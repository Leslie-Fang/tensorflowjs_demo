<!-- Load TensorFlow.js. This is required to use coco-ssd model. -->
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@1.7.0"> </script>
<!-- Load the coco-ssd model. -->
<!--<script src="static/coco-ssd"> </script>-->

<!-- Replace this with your image. Make sure CORS settings allow reading the image! -->
<img id="img" src="static/self_trained_jayz/train_001.jpg"/>
<script src="static/classes_jayz.js"> </script>

<!-- Place your code in the script tag below. You can also use an external .js file -->
<script>
  // Notice there is no 'import' statement. 'cocoSsd' and 'tf' is
  // available on the index-page because of the script tag above.

  const img = document.getElementById('img');

  MODEL_PATH = 'static/self_trained_jayz/model.json'
  let ssdmodel;
  const ssdDemo = async () => {
      // Load the model
      const ssdmodel = await tf.loadGraphModel(MODEL_PATH);

      // Preprocess the image
      const imgElement = document.getElementById('img');
      const input = tf.browser.fromPixels(imgElement).toFloat();
      input2 = await input.expandDims(axis=0);

      const height = input2.shape[1];
      const width = input2.shape[2];

      // Inference
      // model returns two tensors:
      // 1. box classification score with shape of [1, 3(boxes_number), 90]
      // 2. box location with shape of [1, 3(boxes_number), 1, 4]
      // where 1 is the batchsize, 3 is the number of box detectors, 90 is the number of classes.
      // and 4 is the four coordinates of the box.
      result = await ssdmodel.executeAsync(input2); //

      console.log(result);

      num_detections = result[1].dataSync()
      detected_boxes = result[3].dataSync()
      detected_scores = result[4].dataSync()
      detected_classes = result[5].dataSync()
      console.log(num_detections);
      console.log(detected_boxes);
      console.log(detected_scores);
      console.log(detected_classes);

      // Build Detected Objects
      const count = num_detections;
      const objects = [];
      for (let i = 0; i < count; i++) {
        const bbox = [];
        for (let j = 0; j < 4; j++) {
          bbox[j] = detected_boxes[i * 4 + j];
        }
        const minY = bbox[0] * height;
        const minX = bbox[1] * width;
        const maxY = bbox[2] * height;
        const maxX = bbox[3] * width;
        bbox[0] = minX;
        bbox[1] = minY;
        bbox[2] = maxX - minX;
        bbox[3] = maxY - minY;
        objects.push({
          bbox: bbox, //[x, y, width, height]
          class: CLASSES[detected_classes[i]].displayName,
          score: detected_scores[i]
        });
      }
      console.log('Predictions: ', objects);
      //return objects;
  }
  //waiting the image to be loaded
  while(!document.getElementById('img').complete)
  {
    console.log("Waiting");
  }

  ssdDemo();

</script>